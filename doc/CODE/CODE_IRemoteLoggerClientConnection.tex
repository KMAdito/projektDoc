\begin{spacing}{0.75}
	\begin{javacode}
/**
 * Verbindung RemoteLogger
 * Manager->Server
 *
 * @author W.Glanzer, 19.11.2015
 */
public class RemoteLoggerClientConnection implements IRemoteLoggerClientConnection
{
  private final List<IRemoteLoggerListener> loggerListenerList = new ArrayList<>();
  private final String host;
  private final int port;
  private String[] loginInformation;
  private boolean closed = false;
  private Socket clientSocket;
  private ObjectInputStreamConsumer<IRemoteLoggerCheckPoint> streamConsumer;

  public RemoteLoggerClientConnection(String pHost, int pPort, String[] pLoginInformation)
  {
    host = pHost;
    port = pPort;
    loginInformation = pLoginInformation;
  }

  @Override
  public void connect() throws AditoIOException
  {
    if ((clientSocket != null && !clientSocket.isClosed()) || closed)
      return;

    try
    {
      clientSocket = new Socket(host, port);
      streamConsumer = ObjectInputStreamConsumer.consume(clientSocket.getInputStream(), 
        null, this::_fireCheckPointReceived, this::_handleException);

      // Einloggen
      sendCommand(new AuthorizationCommand(loginInformation));

      _fireConnectionStatusChanged(true);
    }
    catch (Exception e)
    {
      throw new AditoIOException(e, 16, 206);
    }
  }

  @Override
  public void close() throws AditoIOException
  {
    try
    {
      if (!closed)
      {
        streamConsumer.requestShutdown(); //schließt den inputStream schon
        closed = true;
        clientSocket = null;
        _fireConnectionStatusChanged(false);
      }
    }
    catch (Exception e)
    {
      throw new AditoIOException(e, 16, 207);
    }
  }

  @Override
  public void sendCommand(@NotNull IRemoteLoggerCommand pCommand) throws AditoIOException
  {
    try
    {
      if (!closed)
      {
        ByteArrayOutputStream outputstream = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(outputstream);
        oos.writeObject(pCommand);
        oos.flush();
        byte[] bytes = outputstream.toByteArray();
        oos.close();\end{javacode}
        \end{spacing}
        \begin{spacing}{0.75}
        	\begin{javacode}[firstnumber=79]
        clientSocket.getOutputStream().write(bytes);
      }
    }
    catch (IOException pE)
    {
      throw new AditoIOException(pE, 16, 208, "type: " + pCommand.getType());
    }
  }

  @Override
  public boolean addListener(IRemoteLoggerListener pListener)
  {
    synchronized (loggerListenerList)
    {
      return loggerListenerList.add(pListener);
    }
  }

  @Override
  public boolean removeListener(@Nullable IRemoteLoggerListener pListener)
  {
    synchronized (loggerListenerList)
    {
      return loggerListenerList.remove(pListener);
    }
  }

  /**
   * Feuert, dass der RemoteLogger einen neuen CheckPoint gebracht hat
   *
   * @param pCheckPoint CheckPoint, den der RemoteLogger gebracht hat, nicht <tt>null</tt>!
   */
  private void _fireCheckPointReceived(@NotNull IRemoteLoggerCheckPoint pCheckPoint)
  {
    synchronized (loggerListenerList)
    {
      for (IRemoteLoggerListener currListener : loggerListenerList)
        currListener.checkPointReceived(pCheckPoint);
    }
  }

  /**
   * Feuert, dass der RemoteLogger seinen Verbindungsstatus geänder hat
   *
   * @param pConnectedNow <tt>true</tt>, wenn der Logger jetzt mit dem am Server verbunden 
   *                      ist, bei <tt>false</tt> hat sich dieser getrennt
   */
  private void _fireConnectionStatusChanged(boolean pConnectedNow)
  {
    synchronized (loggerListenerList)
    {
      for (IRemoteLoggerListener currListener : loggerListenerList)
        currListener.connectionStatusChanged(pConnectedNow);
    }
  }

  /**
   * Wird aufgerufen, wenn im ObjectStreamConsumer eine Fehlermeldung aufgetreten ist
   *
   * @param pException  Exception, die aufgetreten ist
   * @return <tt>true</tt>, wenn aus dem Stream erneut ausgelesen werden soll
   */
  private boolean _handleException(@NotNull Exception pException)
  {
    CPH.checkPoint(pException, 16, 210, CPH.OK_DIALOG);
    _fireConnectionStatusChanged(false);
    return false;
  }
}\end{javacode}
\end{spacing}